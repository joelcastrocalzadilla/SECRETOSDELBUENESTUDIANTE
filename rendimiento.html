<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Balanceo + Reactivo limitante (m√≠nimo funcional)</title>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .fila { margin-bottom: 8px; }
    .paso { background: #fff8e1; border-left: 4px solid #ff9800; padding: 8px; margin-top: 12px; }
    .ok { background: #e8f5e9; border-left-color: #43a047; }
    input, select { margin: 2px 4px; width: 130px; }
    button { margin-top: 8px; }
  </style>
</head>
<body>
  <h1>‚öóÔ∏è M√≠nimo funcional</h1>

  <h2>Reactivos</h2>
  <div class="fila">
    <input id="r1name" placeholder="Compuesto 1" />
    <select id="r1unit"><option value="mol">mol</option><option value="g">gramos</option></select>
    <input id="r1cantidad" type="number" placeholder="Cantidad" />
    <input id="r1e1" placeholder="El1" /><input id="r1s1" type="number" placeholder="Sub1" />
    <input id="r1e2" placeholder="El2" /><input id="r1s2" type="number" placeholder="Sub2" />
    <input id="r1e3" placeholder="El3" /><input id="r1s3" type="number" placeholder="Sub3" />
  </div>
  <div class="fila">
    <input id="r2name" placeholder="Compuesto 2" />
    <select id="r2unit"><option value="mol">mol</option><option value="g">gramos</option></select>
    <input id="r2cantidad" type="number" placeholder="Cantidad" />
    <input id="r2e1" placeholder="El1" /><input id="r2s1" type="number" placeholder="Sub1" />
    <input id="r2e2" placeholder="El2" /><input id="r2s2" type="number" placeholder="Sub2" />
    <input id="r2e3" placeholder="El3" /><input id="r2s3" type="number" placeholder="Sub3" />
  </div>

  <h2>Productos</h2>
  <div class="fila">
    <input id="p1name" placeholder="Producto 1" />
    <input id="p1e1" placeholder="El1" /><input id="p1s1" type="number" placeholder="Sub1" />
    <input id="p1e2" placeholder="El2" /><input id="p1s2" type="number" placeholder="Sub2" />
    <input id="p1e3" placeholder="El3" /><input id="p1s3" type="number" placeholder="Sub3" />
  </div>
  <div class="fila">
    <input id="p2name" placeholder="Producto 2" />
    <input id="p2e1" placeholder="El1" /><input id="p2s1" type="number" placeholder="Sub1" />
    <input id="p2e2" placeholder="El2" /><input id="p2s2" type="number" placeholder="Sub2" />
    <input id="p2e3" placeholder="El3" /><input id="p2s3" type="number" placeholder="Sub3" />
  </div>

  <h2>Producto obtenido</h2>
  <div class="fila">
    <select id="productoPrincipal">
      <option value="0">Producto 1</option>
      <option value="1">Producto 2</option>
    </select>
    <input id="productoObtenido" type="number" placeholder="Cantidad obtenida" />
    <select id="prodUnit"><option value="mol">mol</option><option value="g">gramos</option></select>
  </div>

  <button id="btn" onclick="balancear()">‚ú® Balancear y calcular</button>
  <div id="resultado"></div>

  <script>
  // Masas molares (b√°sico)
  const masasMolares = {
    H:1.008, He:4.0026, Li:6.94, Be:9.0122, B:10.81, C:12.01, N:14.01, O:16.00, F:18.998,
    Na:22.99, Mg:24.305, Al:26.982, Si:28.085, P:30.974, S:32.06, Cl:35.45, K:39.098,
    Ca:40.078, Fe:55.845, Cu:63.546, Zn:65.38, Ag:107.87, I:126.90, Ba:137.33, Au:196.97,
    Hg:200.59, Pb:207.2
  };

  function construirFormula(prefix) {
    let formula = "";
    for (let i=1;i<=3;i++){
      const el = document.getElementById(`${prefix}e${i}`).value.trim();
      const sub = parseInt(document.getElementById(`${prefix}s${i}`).value);
      if (el) {
        formula += el;
        if (sub && sub>1) formula += `_{${sub}}`;
      }
    }
    return formula || document.getElementById(`${prefix}name`).value.trim();
  }

  function calcularMasaMolar(prefix) {
    let masa=0;
    for (let i=1;i<=3;i++){
      const el = document.getElementById(`${prefix}e${i}`).value.trim();
      const sub = parseInt(document.getElementById(`${prefix}s${i}`).value);
      if (el && sub && masasMolares[el]) masa += masasMolares[el]*sub;
    }
    return masa;
  }

  function balancear() {
    try {
      const reactivos = ["r1","r2"].map(prefix => ({
        nombre: document.getElementById(`${prefix}name`).value.trim(),
        unidad: document.getElementById(`${prefix}unit`).value,
        cantidad: parseFloat(document.getElementById(`${prefix}cantidad`).value),
        masaMolar: calcularMasaMolar(prefix),
        formula: construirFormula(prefix),
        elementos: [1,2,3].reduce((obj,i)=>{
          const el=document.getElementById(`${prefix}e${i}`).value.trim();
          const sub=parseInt(document.getElementById(`${prefix}s${i}`).value);
          if (el && sub) obj[el]=sub;
          return obj;
        },{})
      }));

      const productos = ["p1","p2"].map(prefix => ({
        nombre: document.getElementById(`${prefix}name`).value.trim(),
        masaMolar: calcularMasaMolar(prefix),
        formula: construirFormula(prefix),
        elementos: [1,2,3].reduce((obj,i)=>{
          const el=document.getElementById(`${prefix}e${i}`).value.trim();
          const sub=parseInt(document.getElementById(`${prefix}s${i}`).value);
          if (el && sub) obj[el]=sub;
          return obj;
        },{})
      }));

      const productoPrincipalIndex = parseInt(document.getElementById("productoPrincipal").value);
      const productoPrincipal = productos[productoPrincipalIndex];

      // Validaci√≥n m√≠nima
      if (!reactivos[0].formula || !productos[0].formula) {
        document.getElementById("resultado").innerHTML =
          `<div class="paso">Completa al menos R1 y P1 con elementos y sub√≠ndices.</div>`;
        return;
      }

      const elementosSet = new Set();
      [...reactivos, ...productos].forEach(c => Object.keys(c.elementos).forEach(e => elementosSet.add(e)));
      const elementos = Array.from(elementosSet);

      let html = `<div class="paso">üîç Paso 1: Ecuaci√≥n sin balancear<br>
      \

\[${reactivos.map(r=>r.formula).join(" + ")} \\rightarrow ${productos.map(p=>p.formula).join(" + ")}\\]


      </div>`;

      let encontrado=false;
      let coefR=[1,1], coefP=[1,1];

      for (let a1=1;a1<=10;a1++){
        for (let a2=1;a2<=10;a2++){
          for (let b1=1;b1<=10;b1++){
            for (let b2=1;b2<=10;b2++){
              const cR=[a1,a2], cP=[b1,b2];
              const totalR={}, totalP={};
              elementos.forEach(el=>{
                totalR[el]=reactivos.reduce((s,c,i)=>s+(c.elementos[el]||0)*cR[i],0);
                totalP[el]=productos.reduce((s,c,i)=>s+(c.elementos[el]||0)*cP[i],0);
              });
              if (elementos.every(el=>totalR[el]===totalP[el])) {
                coefR=cR; coefP=cP; encontrado=true; break;
              }
            }
            if (encontrado) break;
          }
          if (encontrado) break;
        }
        if (encontrado) break;
      }

      if (!encontrado){
        document.getElementById("resultado").innerHTML =
          html + `<div class="paso">‚ö†Ô∏è No se encontr√≥ balance 1‚Äì10. Revisa sub√≠ndices.</div>`;
        MathJax.typeset(); return;
      }

      const ecuacionBalanceada = [
        ...reactivos.map((c,i)=>`${coefR[i]>1?coefR[i]:""}${c.formula}`),
        "‚Üí",
        ...productos.map((c,i)=>`${coefP[i]>1?coefP[i]:""}${c.formula}`)
      ].join(" + ").replace(" + ‚Üí + "," \\rightarrow ");

      html += `<div class="paso ok">üßÆ Paso 2: Ecuaci√≥n balanceada<br>
      \

\[${ecuacionBalanceada}\\]

</div>`;

      // Reactivo limitante por producci√≥n te√≥rica del producto principal
      const molesProductoPorReactivo = reactivos.map((r,i)=>{
        const coefReactivo = coefR[i];
        const coefProducto = coefP[productoPrincipalIndex];
        if (r.unidad==="g") {
          if (!r.masaMolar || r.masaMolar<=0) return NaN;
          const moles = r.cantidad / r.masaMolar;
          return (moles/coefReactivo)*coefProducto;
        } else {
          return (r.cantidad/coefReactivo)*coefProducto;
        }
      });

      const menor = Math.min(...molesProductoPorReactivo);
      const idxL = molesProductoPorReactivo.indexOf(menor);
      const nombreL = reactivos[idxL]?.nombre || "(desconocido)";

      html += `<div class="paso">üß™ Paso 3: Reactivo limitante<br>
      ${reactivos.map((r,i)=>`- ${r.nombre||"R"+(i+1)}: ${isFinite(molesProductoPorReactivo[i])?molesProductoPorReactivo[i].toFixed(4):"‚Äî"} mol de ${productoPrincipal.formula}`).join("<br>")}
      <br>Limitante: <strong>${nombreL}</strong></div>`;

      // Cantidad te√≥rica y rendimiento
      const molesTeoricos = menor;
      const gTeoricos = (productoPrincipal.masaMolar>0) ? molesTeoricos*productoPrincipal.masaMolar : NaN;

      html += `<div class="paso">üìà Paso 4: Cantidad te√≥rica<br>
      Moles esperados: <strong>${isFinite(molesTeoricos)?molesTeoricos.toFixed(4):"‚Äî"} mol</strong><br>
      ${isFinite(gTeoricos)?`Gramos esperados: <strong>${gTeoricos.toFixed(4)} g</strong>`:`Ingresa elementos del producto para masa molar.`}
      </div>`;

      const obtenido = parseFloat(document.getElementById("productoObtenido").value);
      const unidadObtenida = document.getElementById("prodUnit").value;
      let obtenidoMoles = NaN;
      if (unidadObtenida==="mol") obtenidoMoles = obtenido;
      else if (isFinite(gTeoricos) && productoPrincipal.masaMolar>0) obtenidoMoles = obtenido/productoPrincipal.masaMolar;

      if (!isFinite(obtenidoMoles)) {
        html += `<div class="paso">‚ÑπÔ∏è Paso 5: Para rendimiento, ingresa cantidad obtenida y aseg√∫rate de tener masa molar del producto.</div>`;
      } else {
        const rendimiento = (obtenidoMoles / molesTeoricos) * 100;
        html += `<div class="paso ok">üéØ Paso 5: Rendimiento<br><strong>${rendimiento.toFixed(2)}%</strong></div>`;
      }

      html += `<div class="paso ok">üéâ Secuencia completa.</div>`;
      document.getElementById("resultado").innerHTML = html;
      MathJax.typeset();
    } catch (err) {
      document.getElementById("resultado").innerHTML =
        `<div class="paso">‚ùå Error: ${err.message}</div>`;
      console.error(err);
    }
  }
  </script>
</body>
</html>
